var uint32=require("cuint").UINT32;Math.imul||(Math.imul=function(t,e){var s=65535&t,i=65535&e;return s*i+((t>>>16)*i+s*(e>>>16)<<16)|0}),exports.uncompress=function(t,e,s,i){for(var r=s=s||0,o=i=i||t.length-s,n=0;r<o;){var h=t[r++],c=h>>4;if(0<c){for(var a=c+240;255===a;)c+=a=t[r++];for(var S=r+c;r<S;)e[n++]=t[r++];if(r===o)return n}var u=t[r++]|t[r++]<<8;if(0==u||n<u)return-(r-2);for(var l=15&h,a=l+240;255===a;)l+=a=t[r++];for(var p=n-u,S=n+l+4;n<S;)e[n++]=e[p++]}return n};var maxInputSize=2113929216,minMatch=4,hashLog=16,hashShift=8*minMatch-hashLog,hashSize=1<<hashLog,copyLength=8,lastLiterals=5,mfLimit=copyLength+minMatch,skipStrength=6,mlBits=4,mlMask=(1<<mlBits)-1,runBits=8-mlBits,runMask=(1<<runBits)-1,hasher=2654435761;function compressBlock(t,e,s,i,r,o){var n=r,o=o-r,h=0;if(t.length>=maxInputSize)throw new Error("input too large");if(t.length>mfLimit){r=exports.compressBound(t.length);if(o<r)throw Error("output too small: "+o+" < "+r);for(var c=3+(1<<skipStrength),a=t.length-mfLimit;s+minMatch<a;){var S=t[s+1]<<8|t[s],u=t[s+3]<<8|t[s+2],l=Math.imul(S|u<<16,hasher)>>>hashShift,p=i[l]-1;if(i[l]=s+1,p<0||0<s-p>>>16||(t[p+3]<<8|t[p+2])!=u||(t[p+1]<<8|t[p])!=S)s+=c++>>skipStrength;else{var c=3+(1<<skipStrength),E=s-h,u=s-p;p+=minMatch;for(var d=s+=minMatch;s<a&&t[s]==t[p];)s++,p++;S=(d=s-d)<mlMask?d:mlMask;if(runMask<=E){e[n++]=(runMask<<mlBits)+S;for(var f=E-runMask;254<f;f-=255)e[n++]=255;e[n++]=f}else e[n++]=(E<<mlBits)+S;for(var m=0;m<E;m++)e[n++]=t[h+m];if(e[n++]=u,e[n++]=u>>8,mlMask<=d){for(d-=mlMask;255<=d;)d-=255,e[n++]=255;e[n++]=d}h=s}}}if(0==h)return 0;if(E=t.length-h,runMask<=E){e[n++]=runMask<<mlBits;for(var C=E-runMask;254<C;C-=255)e[n++]=255;e[n++]=C}else e[n++]=E<<mlBits;for(s=h;s<t.length;)e[n++]=t[s++];return n}exports.compressBound=function(t){return maxInputSize<t?0:t+t/255+16|0},exports.compress=function(t,e,s,i){for(var r=new Array(hashSize),o=0;o<hashSize;o++)r[o]=0;return compressBlock(t,e,0,r,s||0,i||e.length)},exports.compressHC=exports.compress,exports.compressDependent=compressBlock;var Decoder=require("./decoder_stream");function LZ4_uncompress(t,e){var s=[],e=new Decoder(e);return e.on("data",function(t){s.push(t)}),e.end(t),Buffer.concat(s)}exports.LZ4_uncompress=LZ4_uncompress;var Transform=require("stream").Transform,inherits=require("util").inherits,utils=(lz4_static=require("./static")).utils,lz4_binding=utils.bindings,lz4_jsbinding=require("./binding"),STATES=lz4_static.STATES,SIZES=lz4_static.SIZES;function Decoder(t){if(!(this instanceof Decoder))return new Decoder(t);Transform.call(this,t),this.options=t||{},this.binding=this.options.useJS?lz4_jsbinding:lz4_binding,this.buffer=null,this.pos=0,this.descriptor=null,this.state=STATES.MAGIC,this.notEnoughData=!1,this.descriptorStart=0,this.streamSize=null,this.dictId=null,this.currentStreamChecksum=null,this.dataBlockSize=0,this.skippableSize=0}inherits(Decoder,Transform),Decoder.prototype._transform=function(t,e,s){if(0<this.skippableSize){if(this.skippableSize-=t.length,0<this.skippableSize)return void s();t=t.slice(-this.skippableSize),this.skippableSize=0,this.state=STATES.MAGIC}this.buffer=this.buffer?Buffer.concat([this.buffer,t],this.buffer.length+t.length):t,this._main(s)},Decoder.prototype.emit_Error=function(t){this.emit("error",new Error(t+" @"+this.pos))},Decoder.prototype.check_Size=function(t){var e=this.buffer.length-this.pos;return e<=0||e<t?(this.notEnoughData&&this.emit_Error("Unexpected end of LZ4 stream"),!0):(this.pos+=t,!1)},Decoder.prototype.read_MagicNumber=function(){var t=this.pos;if(this.check_Size(SIZES.MAGIC))return!0;var e=utils.readUInt32LE(this.buffer,t);if((4294967280&e)!==lz4_static.MAGICNUMBER_SKIPPABLE)return e!==lz4_static.MAGICNUMBER?(this.pos=t,this.emit_Error("Invalid magic number: "+e.toString(16).toUpperCase()),!0):void(this.state=STATES.DESCRIPTOR);this.state=STATES.SKIP_SIZE},Decoder.prototype.read_SkippableSize=function(){var t=this.pos;if(this.check_Size(SIZES.SKIP_SIZE))return!0;this.state=STATES.SKIP_DATA,this.skippableSize=utils.readUInt32LE(this.buffer,t)},Decoder.prototype.read_Descriptor=function(){var t=this.pos;if(this.check_Size(SIZES.DESCRIPTOR))return!0;this.descriptorStart=t;var e=this.buffer[t],s=e>>6;if(s!==lz4_static.VERSION)return this.pos=t,this.emit_Error("Invalid version: "+s+" != "+lz4_static.VERSION),!0;if(e>>1&1)return this.pos=t,this.emit_Error("Reserved bit set"),!0;var i=this.buffer[t+1]>>4&7,s=lz4_static.blockMaxSizes[i];if(null===s)return this.pos=t,this.emit_Error("Invalid block max size: "+i),!0;this.descriptor={blockIndependence:Boolean(e>>5&1),blockChecksum:Boolean(e>>4&1),blockMaxSize:s,streamSize:Boolean(e>>3&1),streamChecksum:Boolean(e>>2&1),dict:Boolean(1&e),dictId:0},this.state=STATES.SIZE},Decoder.prototype.read_Size=function(){if(this.descriptor.streamSize){var t=this.pos;if(this.check_Size(SIZES.SIZE))return!0;this.streamSize=this.buffer.slice(t,t+8)}this.state=STATES.DICTID},Decoder.prototype.read_DictId=function(){if(this.descriptor.dictId){var t=this.pos;if(this.check_Size(SIZES.DICTID))return!0;this.dictId=utils.readUInt32LE(this.buffer,t)}this.state=STATES.DESCRIPTOR_CHECKSUM},Decoder.prototype.read_DescriptorChecksum=function(){var t=this.pos;if(this.check_Size(SIZES.DESCRIPTOR_CHECKSUM))return!0;var e=this.buffer[t];if(utils.descriptorChecksum(this.buffer.slice(this.descriptorStart,t))!==e)return this.pos=t,this.emit_Error("Invalid stream descriptor checksum"),!0;this.state=STATES.DATABLOCK_SIZE},Decoder.prototype.read_DataBlockSize=function(){var t=this.pos;if(this.check_Size(SIZES.DATABLOCK_SIZE))return!0;t=utils.readUInt32LE(this.buffer,t);t!==lz4_static.EOS?(this.dataBlockSize=t,this.state=STATES.DATABLOCK_DATA):this.state=STATES.EOS},Decoder.prototype.read_DataBlockData=function(){var t=this.pos,e=this.dataBlockSize;if(2147483648&e&&(e&=2147483647),this.check_Size(e))return!0;this.dataBlock=this.buffer.slice(t,t+e),this.state=STATES.DATABLOCK_CHECKSUM},Decoder.prototype.read_DataBlockChecksum=function(){var t=this.pos;if(this.descriptor.blockChecksum){if(this.check_Size(SIZES.DATABLOCK_CHECKSUM))return!0;var e=utils.readUInt32LE(this.buffer,this.pos-4);if(utils.blockChecksum(this.dataBlock)!==e)return this.pos=t,this.emit_Error("Invalid block checksum"),!0}this.state=STATES.DATABLOCK_UNCOMPRESS},Decoder.prototype.uncompress_DataBlock=function(){if(2147483648&this.dataBlockSize)t=this.dataBlock;else{var t=Buffer.alloc(this.descriptor.blockMaxSize),e=this.binding.uncompress(this.dataBlock,t);if(e<0)return this.emit_Error("Invalid data block: "+-e),!0;e<this.descriptor.blockMaxSize&&(t=t.slice(0,e))}this.dataBlock=null,this.push(t),this.descriptor.streamChecksum&&(this.currentStreamChecksum=utils.streamChecksum(t,this.currentStreamChecksum)),this.state=STATES.DATABLOCK_SIZE},Decoder.prototype.read_EOS=function(){if(this.descriptor.streamChecksum){var t=this.pos;if(this.check_Size(SIZES.EOS))return!0;var e=utils.readUInt32LE(this.buffer,t);if(e!==utils.streamChecksum(null,this.currentStreamChecksum))return this.pos=t,this.emit_Error("Invalid stream checksum: "+e.toString(16).toUpperCase()),!0}this.state=STATES.MAGIC},Decoder.prototype._flush=function(t){this.notEnoughData=!0,this._main(t)},Decoder.prototype._main=function(t){for(var e,s=this.pos;!e&&this.pos<this.buffer.length;)this.state===STATES.MAGIC&&(e=this.read_MagicNumber()),this.state===STATES.SKIP_SIZE&&(e=this.read_SkippableSize()),this.state===STATES.DESCRIPTOR&&(e=this.read_Descriptor()),this.state===STATES.SIZE&&(e=this.read_Size()),this.state===STATES.DICTID&&(e=this.read_DictId()),this.state===STATES.DESCRIPTOR_CHECKSUM&&(e=this.read_DescriptorChecksum()),this.state===STATES.DATABLOCK_SIZE&&(e=this.read_DataBlockSize()),this.state===STATES.DATABLOCK_DATA&&(e=this.read_DataBlockData()),this.state===STATES.DATABLOCK_CHECKSUM&&(e=this.read_DataBlockChecksum()),this.state===STATES.DATABLOCK_UNCOMPRESS&&(e=this.uncompress_DataBlock()),this.state===STATES.EOS&&(e=this.read_EOS());this.pos>s&&(this.buffer=this.buffer.slice(this.pos),this.pos=0),t()},module.exports=Decoder;var Encoder=require("./encoder_stream");function LZ4_compress(t,e){var s=[],e=new Encoder(e);return e.on("data",function(t){s.push(t)}),e.end(t),Buffer.concat(s)}exports.LZ4_compress=LZ4_compress;var Transform=require("stream").Transform,inherits=require("util").inherits,lz4_static=require("./static"),lz4_binding=(utils=lz4_static.utils).bindings,lz4_jsbinding=require("./binding"),STATES=lz4_static.STATES,SIZES=lz4_static.SIZES,defaultOptions={blockIndependence:!0,blockChecksum:!1,blockMaxSize:4<<20,streamSize:!1,streamChecksum:!0,dict:!1,dictId:0,highCompression:!1};function Encoder(t){if(!(this instanceof Encoder))return new Encoder(t);Transform.call(this,t);var e=t||defaultOptions;e!==defaultOptions&&Object.keys(defaultOptions).forEach(function(t){e.hasOwnProperty(t)||(e[t]=defaultOptions[t])}),this.options=e,this.binding=this.options.useJS?lz4_jsbinding:lz4_binding,this.compress=e.highCompression?this.binding.compressHC:this.binding.compress;var s=0,s=0|lz4_static.VERSION<<6;s|=(1&e.blockIndependence)<<5,s|=(1&e.blockChecksum)<<4,s|=(1&e.streamSize)<<3,s|=(1&e.streamChecksum)<<2,s|=1&e.dict;t=lz4_static.blockMaxSizes.indexOf(e.blockMaxSize);if(t<0)throw new Error("Invalid blockMaxSize: "+e.blockMaxSize);this.descriptor={flg:s,bd:(7&t)<<4},this.buffer=[],this.length=0,this.first=!0,this.checksum=null}inherits(Encoder,Transform),Encoder.prototype.headerSize=function(){var t=this.options.streamSize?SIZES.DESCRIPTOR:0,e=this.options.dict?SIZES.DICTID:0;return SIZES.MAGIC+1+1+t+e+1},Encoder.prototype.header=function(){var t=this.headerSize(),e=Buffer.alloc(t);this.state=STATES.MAGIC,e.writeInt32LE(lz4_static.MAGICNUMBER,0),this.state=STATES.DESCRIPTOR;var s=e.slice(SIZES.MAGIC,e.length-1);s.writeUInt8(this.descriptor.flg,0),s.writeUInt8(this.descriptor.bd,1);t=2;return this.state=STATES.SIZE,this.options.streamSize&&(s.writeInt32LE(0,t),s.writeInt32LE(this.size,t+4),t+=SIZES.SIZE),this.state=STATES.DICTID,this.options.dict&&(s.writeInt32LE(this.dictId,t),t+=SIZES.DICTID),this.state=STATES.DESCRIPTOR_CHECKSUM,e.writeUInt8(utils.descriptorChecksum(s),SIZES.MAGIC+t),e},Encoder.prototype.update_Checksum=function(t){this.state=STATES.CHECKSUM_UPDATE,this.options.streamChecksum&&(this.checksum=utils.streamChecksum(t,this.checksum))},Encoder.prototype.compress_DataBlock=function(t){this.state=STATES.DATABLOCK_COMPRESS;var e=this.options.blockChecksum?SIZES.DATABLOCK_CHECKSUM:0,s=this.binding.compressBound(t.length),i=Buffer.alloc(SIZES.DATABLOCK_SIZE+s+e),r=i.slice(SIZES.DATABLOCK_SIZE,SIZES.DATABLOCK_SIZE+s),s=this.compress(t,r);return this.state=STATES.DATABLOCK_SIZE,0<s&&s<=this.options.blockMaxSize?(i.writeUInt32LE(s,0),i=i.slice(0,SIZES.DATABLOCK_SIZE+s+e)):(i.writeInt32LE(2147483648|t.length,0),i=i.slice(0,SIZES.DATABLOCK_SIZE+t.length+e),t.copy(i,SIZES.DATABLOCK_SIZE)),this.state=STATES.DATABLOCK_CHECKSUM,this.options.blockChecksum&&i.slice(-e).writeInt32LE(utils.blockChecksum(r),0),this.update_Checksum(t),this.size+=t.length,i},Encoder.prototype._transform=function(t,e,s){t&&(this.buffer.push(t),this.length+=t.length),this.first&&(this.push(this.header()),this.first=!1);var i=this.options.blockMaxSize;if(this.length<i)return s();for(var r=Buffer.concat(this.buffer,this.length),o=0,n=r.length;i<=n;n-=i,o+=i)this.push(this.compress_DataBlock(r.slice(o,o+i)));0<n?(this.buffer=[r.slice(o)],this.length=this.buffer[0].length):(this.buffer=[],this.length=0),s()},Encoder.prototype._flush=function(t){var e,s;this.first&&(this.push(this.header()),this.first=!1),0<this.length&&(e=Buffer.concat(this.buffer,this.length),this.buffer=[],this.length=0,e=this.compress_DataBlock(e),this.push(e)),this.options.streamChecksum?(this.state=STATES.CHECKSUM,(s=Buffer.alloc(SIZES.EOS+SIZES.CHECKSUM)).writeUInt32LE(utils.streamChecksum(null,this.checksum),SIZES.EOS)):s=Buffer.alloc(SIZES.EOS),this.state=STATES.EOS,s.writeInt32LE(lz4_static.EOS,0),this.push(s),t()},module.exports=Encoder,module.exports=require("./static"),module.exports.version="0.5.1",module.exports.createDecoderStream=require("./decoder_stream"),module.exports.decode=require("./decoder").LZ4_uncompress,module.exports.createEncoderStream=require("./encoder_stream"),module.exports.encode=require("./encoder").LZ4_compress;var bindings=module.exports.utils.bindings;module.exports.decodeBlock=bindings.uncompress,module.exports.encodeBound=bindings.compressBound,module.exports.encodeBlock=bindings.compress,module.exports.encodeBlockHC=bindings.compressHC,lz4.js,exports.MAGICNUMBER=407708164,exports.MAGICNUMBER_BUFFER=Buffer.alloc(4),exports.MAGICNUMBER_BUFFER.writeUInt32LE(exports.MAGICNUMBER,0),exports.EOS=0,exports.EOS_BUFFER=Buffer.alloc(4),exports.EOS_BUFFER.writeUInt32LE(exports.EOS,0),exports.VERSION=1,exports.MAGICNUMBER_SKIPPABLE=407710288,exports.blockMaxSizes=[null,null,null,null,65536,262144,1<<20,4<<20],exports.extension=".lz4",exports.STATES={MAGIC:0,DESCRIPTOR:1,SIZE:2,DICTID:3,DESCRIPTOR_CHECKSUM:4,DATABLOCK_SIZE:5,DATABLOCK_DATA:6,DATABLOCK_CHECKSUM:7,DATABLOCK_UNCOMPRESS:8,DATABLOCK_COMPRESS:9,CHECKSUM:10,CHECKSUM_UPDATE:11,EOS:90,SKIP_SIZE:101,SKIP_DATA:102},exports.SIZES={MAGIC:4,DESCRIPTOR:2,SIZE:8,DICTID:4,DESCRIPTOR_CHECKSUM:1,DATABLOCK_SIZE:4,DATABLOCK_CHECKSUM:4,CHECKSUM:4,EOS:4,SKIP_SIZE:4},exports.utils=require("./utils");var XXH=require("xxhashjs").h32,CHECKSUM_SEED=0;exports.descriptorChecksum=function(t){return XXH(t,CHECKSUM_SEED).toNumber()>>8&255},exports.blockChecksum=function(t){return XXH(t,CHECKSUM_SEED).toNumber()},exports.streamChecksum=function(t,e){return null===t?e.digest().toNumber():(e=null===e?XXH(CHECKSUM_SEED):e).update(t)},exports.readUInt32LE=function(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0},exports.bindings=require("./binding");XXH=require("../build/Release/xxhash"),CHECKSUM_SEED=0;exports.descriptorChecksum=function(t){return XXH.xxHash(t,CHECKSUM_SEED)>>8&255},exports.blockChecksum=function(t){return XXH.xxHash(t,CHECKSUM_SEED)},exports.streamChecksum=function(t,e){return null===e&&(e=XXH.init(CHECKSUM_SEED)),null===t?XXH.digest(e):(XXH.update(e,t),e)},exports.readUInt32LE=function(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]>>>0},exports.bindings=require("../build/Release/lz4");